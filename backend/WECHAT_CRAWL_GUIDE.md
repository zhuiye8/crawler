# å¾®ä¿¡å…¬ä¼—å·çˆ¬å–åŠŸèƒ½ä½¿ç”¨æŒ‡å—

> âš ï¸ **é‡è¦æ³•å¾‹å£°æ˜**
>
> æ­¤åŠŸèƒ½**ä»…ä¾›ä¸ªäººå­¦ä¹ ç ”ç©¶ä½¿ç”¨**ã€‚å•†ä¸šä½¿ç”¨å¯èƒ½è¿åï¼š
> - å¾®ä¿¡å…¬ä¼—å¹³å°æœåŠ¡åè®®
> - ä¸­åäººæ°‘å…±å’Œå›½åä¸æ­£å½“ç«äº‰æ³•
> - å…¶ä»–ç›¸å…³æ³•å¾‹æ³•è§„
>
> ä½¿ç”¨å‰è¯·ç¡®ä¿ï¼š
> - âœ… å·²è·å¾—å†…å®¹æ‰€æœ‰è€…çš„æ˜ç¡®æˆæƒ
> - âœ… ä»…ç”¨äºä¸ªäººå­¦ä¹ ç ”ç©¶ç›®çš„
> - âœ… ä¸è¿›è¡Œå•†ä¸šåŒ–åˆ©ç”¨
> - âœ… éµå®ˆçˆ¬å–é¢‘ç‡é™åˆ¶
>
> **å¼€å‘è€…ä¸æ‰¿æ‹…ä»»ä½•ç”±æ­¤äº§ç”Ÿçš„æ³•å¾‹è´£ä»»ã€‚**

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬ç³»ç»Ÿé›†æˆäº†å¾®ä¿¡å…¬ä¼—å·æ–‡ç« å®Œæ•´å†…å®¹çˆ¬å–åŠŸèƒ½ï¼Œå·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

```
1. çˆ¬å–è¯æ¸¡äº‘æ–‡ç« åˆ—è¡¨
   â†“
2. è®¿é—®è¯æ¸¡äº‘æ–‡ç« è¯¦æƒ…é¡µ
   â†“
3. æå–æ–‡ç« å†…å®¹ + å¾®ä¿¡åŸæ–‡é“¾æ¥
   â†“
4. å¦‚æœæœ‰å¾®ä¿¡åŸæ–‡é“¾æ¥ â†’ çˆ¬å–å¾®ä¿¡å®Œæ•´å†…å®¹
   â†“
5. å¯¹æ¯”è¯æ¸¡äº‘å’Œå¾®ä¿¡å†…å®¹ï¼Œé€‰æ‹©æ›´å®Œæ•´çš„ç‰ˆæœ¬
   â†“
6. å­˜å‚¨åˆ°æ•°æ®åº“ï¼ˆPostgreSQL + MinIOï¼‰
```

### æ ¸å¿ƒç‰¹æ€§

- âœ… **æ™ºèƒ½é™çº§**ï¼šå¾®ä¿¡çˆ¬å–å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨è¯æ¸¡äº‘å†…å®¹
- âœ… **å†…å®¹å¯¹æ¯”**ï¼šè‡ªåŠ¨é€‰æ‹©æ›´å®Œæ•´çš„å†…å®¹ç‰ˆæœ¬
- âœ… **åçˆ¬ç­–ç•¥**ï¼šéšæœºUAã€å»¶è¿Ÿæ§åˆ¶ã€é‡è¯•æœºåˆ¶
- âœ… **ç¼“å­˜æœºåˆ¶**ï¼šé¿å…é‡å¤çˆ¬å–åŒä¸€æ–‡ç« 
- âœ… **åŒç‰ˆæœ¬ä¿å­˜**ï¼šåŒæ—¶ä¿å­˜è¯æ¸¡äº‘å’Œå¾®ä¿¡ç‰ˆæœ¬
- âœ… **å¯é…ç½®å¼€å…³**ï¼šå¯éšæ—¶å¯ç”¨/ç¦ç”¨å¾®ä¿¡çˆ¬å–

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1: æ•°æ®åº“è¿ç§»

è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼Œæ·»åŠ å¾®ä¿¡ç›¸å…³å­—æ®µï¼š

```bash
cd backend
conda activate lh
python scripts/migrate_add_wechat_fields.py
```

é¢„æœŸè¾“å‡ºï¼š
```
ğŸš€ å¼€å§‹æ•°æ®åº“è¿ç§»...
ğŸ“‹ æ·»åŠ å¾®ä¿¡ç›¸å…³å­—æ®µåˆ° articles è¡¨...
  âœ… æˆåŠŸæ‰§è¡Œ: ALTER TABLE articles ADD COLUMN IF NOT EXISTS...
  âœ… æˆåŠŸæ‰§è¡Œ: ALTER TABLE articles ADD COLUMN IF NOT EXISTS...
  âœ… æˆåŠŸæ‰§è¡Œ: ALTER TABLE articles ADD COLUMN IF NOT EXISTS...
  âœ… æˆåŠŸæ‰§è¡Œ: ALTER TABLE articles ADD COLUMN IF NOT EXISTS...
âœ… æ•°æ®åº“è¿ç§»å®Œæˆï¼
```

### æ­¥éª¤ 2: æµ‹è¯•å•ç¯‡æ–‡ç« ï¼ˆæ¨èï¼‰

åœ¨è¿è¡Œå®Œæ•´çˆ¬å–å‰ï¼Œå…ˆæµ‹è¯•å•ç¯‡æ–‡ç« ï¼š

```bash
python scripts/test_wechat_single.py
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
1. çˆ¬å–è¯æ¸¡äº‘æ–‡ç« è¯¦æƒ…é¡µ
2. æå–å¾®ä¿¡åŸæ–‡é“¾æ¥
3. çˆ¬å–å¾®ä¿¡å®Œæ•´å†…å®¹
4. ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
5. ä¿å­˜HTMLæ–‡ä»¶ä¾›äººå·¥æ£€æŸ¥

**ç”Ÿæˆçš„æ–‡ä»¶ï¼š**
- `test_pharnex_content.html` - è¯æ¸¡äº‘ç‰ˆæœ¬
- `test_wechat_content.html` - å¾®ä¿¡ç‰ˆæœ¬

### æ­¥éª¤ 3: è¿è¡Œå®Œæ•´çˆ¬å–

æµ‹è¯•æˆåŠŸåï¼Œè¿è¡Œå®Œæ•´çˆ¬å–æµç¨‹ï¼š

```bash
python scripts/crawl_and_ingest.py
```

é¢„æœŸè¾“å‡ºï¼š
```
ğŸš€ å¼€å§‹çˆ¬å–...
ğŸ“Œ å¾®ä¿¡çˆ¬å–: âœ… å¯ç”¨

ğŸ“„ Crawling page 1: https://www.pharnexcloud.com/zixun/shiye/qy?page=1
âœ… Page 1: Found 20 articles

ğŸ“ å¤„ç†æ–‡ç« : å®Œèƒœå¸ç¾æ ¼é²è‚½
  ğŸ”— æ‰¾åˆ°å¾®ä¿¡åŸæ–‡é“¾æ¥: https://mp.weixin.qq.com/s/...
  ğŸ”— å‘ç°å¾®ä¿¡åŸæ–‡é“¾æ¥ï¼Œå°è¯•çˆ¬å–...
  âœ… æˆåŠŸçˆ¬å–å¾®ä¿¡å†…å®¹ (5234 å­—ç¬¦)
  â„¹ï¸  ä½¿ç”¨å¾®ä¿¡å†…å®¹ä½œä¸ºä¸»å†…å®¹
  âœ… å·²å…¥åº“: å®Œèƒœå¸ç¾æ ¼é²è‚½ (ID: 123, æ¥æº: wechat)

...
```

---

## âš™ï¸ é…ç½®é€‰é¡¹

ç¼–è¾‘ `backend/scripts/crawl_and_ingest.py` é¡¶éƒ¨çš„é…ç½®ï¼š

```python
# æ˜¯å¦å¯ç”¨å¾®ä¿¡å…¬ä¼—å·çˆ¬å–
ENABLE_WECHAT_CRAWL = True   # æ”¹ä¸º False ç¦ç”¨å¾®ä¿¡çˆ¬å–

# å¾®ä¿¡çˆ¬å–é—´éš”ï¼ˆç§’ï¼‰- å»ºè®®10ç§’ä»¥ä¸Šé¿å…è¢«å°
WECHAT_CRAWL_DELAY = 10      # å¯æ ¹æ®éœ€è¦è°ƒæ•´
```

### å…³é—­å¾®ä¿¡çˆ¬å–

å¦‚æœåªæƒ³ä¿å­˜å¾®ä¿¡é“¾æ¥ä½†ä¸çˆ¬å–å†…å®¹ï¼š

```python
ENABLE_WECHAT_CRAWL = False
```

è¿™æ ·ç³»ç»Ÿä¼šï¼š
- âœ… ä»ç„¶æå–å¹¶ä¿å­˜å¾®ä¿¡åŸæ–‡é“¾æ¥
- âŒ ä¸çˆ¬å–å¾®ä¿¡å®Œæ•´å†…å®¹
- âœ… åªä½¿ç”¨è¯æ¸¡äº‘å†…å®¹

---

## ğŸ“Š æ•°æ®åº“Schema

æ–°å¢å­—æ®µè¯´æ˜ï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `content_source` | VARCHAR(50) | å†…å®¹æ¥æºæ ‡è®°ï¼š`pharnexcloud` æˆ– `wechat` |
| `original_source_url` | TEXT | å¾®ä¿¡å…¬ä¼—å·åŸæ–‡é“¾æ¥ï¼ˆå¯ä¸ºç©ºï¼‰ |
| `wechat_content_html` | TEXT | å¾®ä¿¡æ–‡ç« å®Œæ•´HTMLå†…å®¹ï¼ˆå¦‚æœçˆ¬å–æˆåŠŸï¼‰ |
| `wechat_content_text` | TEXT | å¾®ä¿¡æ–‡ç« å®Œæ•´çº¯æ–‡æœ¬ï¼ˆå¦‚æœçˆ¬å–æˆåŠŸï¼‰ |

### æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥çœ‹æœ‰å¾®ä¿¡åŸæ–‡çš„æ–‡ç« 
SELECT id, title, original_source_url, content_source
FROM articles
WHERE original_source_url IS NOT NULL;

-- æŸ¥çœ‹æˆåŠŸçˆ¬å–å¾®ä¿¡å†…å®¹çš„æ–‡ç« 
SELECT id, title, content_source,
       LENGTH(content_text) as content_len,
       LENGTH(wechat_content_text) as wechat_len
FROM articles
WHERE content_source = 'wechat';

-- å†…å®¹æ¥æºç»Ÿè®¡
SELECT content_source, COUNT(*) as count
FROM articles
GROUP BY content_source;
```

---

## ğŸ” æµ‹è¯•ä¸éªŒè¯

### ç‹¬ç«‹æµ‹è¯•å¾®ä¿¡çˆ¬è™«

å¦‚æœå·²çŸ¥å¾®ä¿¡URLï¼Œå¯ä»¥ç›´æ¥æµ‹è¯•ï¼š

```bash
python scripts/test_wechat_single.py
# é€‰æ‹©é€‰é¡¹ 2: ä»…æµ‹è¯•å¾®ä¿¡çˆ¬å–
# è¾“å…¥å¾®ä¿¡æ–‡ç« URL
```

### æ£€æŸ¥çˆ¬å–ç»“æœ

```bash
# è¿æ¥æ•°æ®åº“
docker exec -it medical-news-postgres psql -U postgres -d medical_news

# æŸ¥çœ‹çˆ¬å–ç»Ÿè®¡
SELECT
  content_source,
  COUNT(*) as count,
  AVG(LENGTH(content_text)) as avg_length
FROM articles
GROUP BY content_source;

# æŸ¥çœ‹æœ€æ–°çˆ¬å–çš„æ–‡ç« 
SELECT id, title, author, content_source, created_at
FROM articles
ORDER BY created_at DESC
LIMIT 10;
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹ä¸é£é™©

### æ³•å¾‹é£é™©

1. **ä¸æ­£å½“ç«äº‰é£é™©**
   - å·²æœ‰å…¬å¸å› çˆ¬å–å¾®ä¿¡æ•°æ®è¢«ç½šæ¬¾60ä¸‡å…ƒ
   - å»ºè®®ä»…ç”¨äºä¸ªäººå­¦ä¹ ï¼Œä¸å•†ä¸šåŒ–ä½¿ç”¨

2. **ç‰ˆæƒé£é™©**
   - å¾®ä¿¡æ–‡ç« å†…å®¹å—ç‰ˆæƒä¿æŠ¤
   - æœªç»æˆæƒè½¬è½½å¯èƒ½ä¾µæƒ

3. **æœåŠ¡åè®®**
   - è¿åå¾®ä¿¡å…¬ä¼—å¹³å°æœåŠ¡åè®®
   - å¯èƒ½å¯¼è‡´è´¦å·å°ç¦æˆ–æ³•å¾‹è¯‰è®¼

### æŠ€æœ¯é£é™©

1. **IPå°ç¦**
   - é¢‘ç¹çˆ¬å–å¯èƒ½å¯¼è‡´IPè¢«å°
   - å»ºè®®è®¾ç½®è¾ƒé•¿çš„å»¶è¿Ÿï¼ˆ10ç§’ä»¥ä¸Šï¼‰

2. **åçˆ¬æ£€æµ‹**
   - å¾®ä¿¡æœ‰ä¸¥æ ¼çš„åçˆ¬æœºåˆ¶
   - å¯èƒ½è§¦å‘éªŒè¯ç æˆ–ä¸´æ—¶å°ç¦

3. **å†…å®¹å˜åŒ–**
   - æ–‡ç« å¯èƒ½è¢«åˆ é™¤
   - é“¾æ¥å¯èƒ½å¤±æ•ˆ

### æœ€ä½³å®è·µ

âœ… **æ¨èåšæ³•ï¼š**
- è®¾ç½®åˆç†çš„çˆ¬å–é¢‘ç‡ï¼ˆå»¶è¿Ÿ10-15ç§’ï¼‰
- å®šæœŸæ£€æŸ¥ç¼“å­˜å¹¶æ¸…ç†
- ç›‘æ§çˆ¬å–æˆåŠŸç‡
- ä¿ç•™é™çº§æ–¹æ¡ˆï¼ˆè¯æ¸¡äº‘å†…å®¹ï¼‰
- å®šæœŸå¤‡ä»½æ•°æ®

âŒ **é¿å…åšæ³•ï¼š**
- çŸ­æ—¶é—´å¤§é‡çˆ¬å–
- å•†ä¸šåŒ–ä½¿ç”¨çˆ¬å–å†…å®¹
- å¿½ç•¥æ³•å¾‹é£é™©è­¦å‘Š
- ç»•è¿‡æŠ€æœ¯ä¿æŠ¤æªæ–½

---

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1: å¾®ä¿¡çˆ¬å–å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
âš ï¸  å¾®ä¿¡çˆ¬å–å¤±è´¥ï¼Œé™çº§ä½¿ç”¨è¯æ¸¡äº‘å†…å®¹
```

**å¯èƒ½åŸå› ï¼š**
- ç½‘ç»œé—®é¢˜
- å¾®ä¿¡åçˆ¬æ£€æµ‹
- URLå¤±æ•ˆ

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼ˆ`WECHAT_CRAWL_DELAY = 15`ï¼‰
3. æ£€æŸ¥ç¼“å­˜ç›®å½• `backend/cache/wechat_articles/`
4. æ‰‹åŠ¨è®¿é—®é“¾æ¥éªŒè¯æ˜¯å¦æœ‰æ•ˆ

### é—®é¢˜2: æ•°æ®åº“è¿ç§»å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
æ‰§è¡Œå¤±è´¥ (å¯èƒ½å­—æ®µå·²å­˜åœ¨)
```

**è§£å†³æ–¹æ¡ˆï¼š**
- è¿™æ˜¯æ­£å¸¸æç¤ºï¼Œè¡¨ç¤ºå­—æ®µå¯èƒ½å·²ç»å­˜åœ¨
- å¦‚æœç¡®å®æœ‰é—®é¢˜ï¼Œè¿è¡Œå›æ»šï¼š
  ```bash
  python scripts/migrate_add_wechat_fields.py --rollback
  ```

### é—®é¢˜3: æœªæ‰¾åˆ°å¾®ä¿¡é“¾æ¥

**ç—‡çŠ¶ï¼š**
```
æœªæ‰¾åˆ°å¾®ä¿¡é“¾æ¥
```

**å¯èƒ½åŸå› ï¼š**
- è¯¥æ–‡ç« ç¡®å®æ²¡æœ‰å¾®ä¿¡åŸæ–‡
- è¯æ¸¡äº‘é¡µé¢ç»“æ„å˜åŒ–

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ‰‹åŠ¨è®¿é—®è¯æ¸¡äº‘æ–‡ç« ç¡®è®¤æ˜¯å¦æœ‰"æŸ¥çœ‹åŸæ–‡"
2. æ£€æŸ¥ `test_article_full.html` æ–‡ä»¶
3. æ›´æ–° `_extract_wechat_url` æ–¹æ³•çš„é€‰æ‹©å™¨

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ models.py                      # æ•°æ®åº“æ¨¡å‹ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ crawler/
â”‚   â”œâ”€â”€ pharnex_crawler.py             # è¯æ¸¡äº‘çˆ¬è™«ï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â””â”€â”€ wechat_crawler.py              # å¾®ä¿¡çˆ¬è™«ï¼ˆæ–°å¢ï¼‰â­
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ crawl_and_ingest.py            # ä¸»çˆ¬å–è„šæœ¬ï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â”œâ”€â”€ migrate_add_wechat_fields.py   # æ•°æ®åº“è¿ç§»ï¼ˆæ–°å¢ï¼‰â­
â”‚   â””â”€â”€ test_wechat_single.py          # æµ‹è¯•è„šæœ¬ï¼ˆæ–°å¢ï¼‰â­
â”œâ”€â”€ cache/
â”‚   â””â”€â”€ wechat_articles/               # å¾®ä¿¡æ–‡ç« ç¼“å­˜ç›®å½•
â””â”€â”€ WECHAT_CRAWL_GUIDE.md              # æœ¬æ–‡æ¡£ï¼ˆæ–°å¢ï¼‰â­
```

---

## ğŸ“ è·å–å¸®åŠ©

é‡åˆ°é—®é¢˜ï¼Ÿ

1. æŸ¥çœ‹ `FIXES.md` ä¸­çš„ç¬¬7æ¡è®°å½•
2. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—è¾“å‡º
3. æŸ¥çœ‹ç”Ÿæˆçš„æµ‹è¯•HTMLæ–‡ä»¶
4. æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ•°æ®

---

## ğŸ”„ åç»­ç»´æŠ¤

### å®šæœŸæ£€æŸ¥

1. **ç›‘æ§çˆ¬å–æˆåŠŸç‡**
   ```sql
   SELECT
     DATE(created_at) as date,
     content_source,
     COUNT(*) as count
   FROM articles
   WHERE created_at > NOW() - INTERVAL '7 days'
   GROUP BY DATE(created_at), content_source
   ORDER BY date DESC;
   ```

2. **æ¸…ç†ç¼“å­˜**
   ```bash
   # æ¸…ç†7å¤©å‰çš„ç¼“å­˜
   find backend/cache/wechat_articles/ -name "*.json" -mtime +7 -delete
   ```

3. **æ›´æ–°é€‰æ‹©å™¨**
   - å¦‚æœè¯æ¸¡äº‘æˆ–å¾®ä¿¡é¡µé¢ç»“æ„å˜åŒ–
   - æ›´æ–° `_extract_wechat_url` æˆ– `_parse_article_page` æ–¹æ³•

---

**æœ€åæé†’ï¼šè¯·åŠ¡å¿…éµå®ˆæ³•å¾‹æ³•è§„ï¼Œä»…å°†æ­¤åŠŸèƒ½ç”¨äºä¸ªäººå­¦ä¹ ç ”ç©¶ç›®çš„ã€‚** ğŸ™
